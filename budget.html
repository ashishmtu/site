<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Yearly Budget Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: The SPA is designed as an interactive dashboard. The top section provides a high-level summary and global inputs (Savings, Goal) for an immediate overview. A main content area is split into two switchable views: "Dashboard" for data visualization (charts) and "Transactions" for detailed data entry. This separation prevents clutter, allowing the user to focus either on analysis (charts) or on the task of inputting data (forms/tables). This task-oriented design is more intuitive than a simple list of monthly tables, as it consolidates controls and provides powerful, aggregated visual feedback. -->
    <!-- Visualization & Content Choices: 
        - Summary Cards (HTML/CSS): Goal: Inform. Provides at-a-glance totals for income, expenses, and savings. Interaction: Dynamically updates on any data change. Justification: Offers immediate feedback on financial health.
        - Progress Bar (HTML/CSS): Goal: Inform. Visualizes progress towards the savings goal. Interaction: Updates dynamically. Justification: More engaging than a simple number.
        - Monthly Cash Flow (Line Chart, Chart.js): Goal: Compare/Analyze. Allows detailed analysis of daily balance fluctuations within a selected month. Interaction: Tooltips on hover, dropdown to select month. Justification: Crucial for understanding the impact of transaction timing.
        - Cumulative Savings Trend (Line Chart, Chart.js): Goal: Change. Shows the growth of savings over the year. Interaction: Tooltips on hover. Justification: Best visualization for showing trends over time.
        - Expense Breakdown (Doughnut Chart, Chart.js): Goal: Organize. Shows the proportion of spending per category. Interaction: Tooltips and a dropdown to filter by month. Justification: Effectively displays part-to-whole relationships.
        - Transaction Table (HTML Table + JS): Goal: Organize/Input. Allows for detailed entry (with dates), review, and deletion of transactions. Interaction: Form submission to add, button click to delete. Justification: A standard and effective UI pattern for managing tabular data.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container { height: 350px; }
        }
        .view { display: none; }
        .view.active { display: block; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <div id="app-container" class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-stone-700">Yearly Budget Dashboard</h1>
            <p class="text-stone-500 mt-2">An interactive way to track your income, expenses, and savings.</p>
        </header>

        <section id="summary-section" class="mb-8 p-6 bg-white rounded-2xl shadow-sm">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div>
                    <label for="existing-savings" class="block text-sm font-medium text-stone-600">Existing Savings</label>
                    <input type="number" id="existing-savings" value="0" class="mt-1 block w-full bg-stone-100 border-transparent rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg p-2">
                </div>
                <div>
                    <label for="savings-goal" class="block text-sm font-medium text-stone-600">Yearly Savings Goal</label>
                    <input type="number" id="savings-goal" value="10000" class="mt-1 block w-full bg-stone-100 border-transparent rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg p-2">
                </div>
                 <div>
                    <label for="savings-end-date" class="block text-sm font-medium text-stone-600">Calculate Savings Until</label>
                    <input type="date" id="savings-end-date" class="mt-1 block w-full bg-stone-100 border-transparent rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg p-2">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                 <div class="p-4 bg-green-50 rounded-lg">
                    <h3 class="text-sm font-medium text-green-700">Projected Savings</h3>
                    <p id="projected-savings" class="text-2xl font-bold text-green-800">$0.00</p>
                </div>
                <div class="p-4 bg-blue-50 rounded-lg">
                    <h3 class="text-sm font-medium text-blue-700">Total Expenses</h3>
                    <p id="total-expenses" class="text-2xl font-bold text-blue-800">$0.00</p>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-stone-600 mb-1">Progress Towards Goal</label>
                <div class="w-full bg-stone-200 rounded-full h-4">
                    <div id="progress-bar" class="bg-teal-500 h-4 rounded-full transition-all duration-500" style="width: 0%;"></div>
                </div>
                <p id="progress-text" class="text-right text-sm text-stone-500 mt-1">0%</p>
            </div>
        </section>

        <main class="bg-white p-4 md:p-6 rounded-2xl shadow-sm">
            <div class="border-b border-stone-200 mb-6">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="nav-dashboard" class="nav-btn text-teal-600 border-teal-500 border-b-2 px-3 py-2 text-sm font-medium">Dashboard</button>
                    <button id="nav-transactions" class="nav-btn text-stone-500 hover:text-stone-700 border-transparent border-b-2 px-3 py-2 text-sm font-medium">Transactions</button>
                </nav>
            </div>

            <div id="dashboard-view" class="view active">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="p-4 rounded-lg bg-stone-50">
                        <div class="flex justify-center items-center mb-4">
                             <h2 class="text-lg font-semibold text-center text-stone-700 mr-4">Monthly Cash Flow</h2>
                             <select id="cash-flow-month-filter" class="bg-white border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-sm p-1"></select>
                        </div>
                        <div class="chart-container"><canvas id="cashFlowChart"></canvas></div>
                    </div>
                    <div class="p-4 rounded-lg bg-stone-50">
                        <h2 class="text-lg font-semibold mb-4 text-center text-stone-700">Cumulative Savings Trend</h2>
                        <div class="chart-container"><canvas id="savingsTrendChart"></canvas></div>
                    </div>
                    <div class="p-4 rounded-lg bg-stone-50 lg:col-span-2">
                        <div class="flex justify-center items-center mb-4">
                            <h2 class="text-lg font-semibold text-center text-stone-700 mr-4">Expense Breakdown</h2>
                            <select id="expense-chart-month-filter" class="bg-white border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-sm p-1">
                                <option value="all">All Months</option>
                            </select>
                        </div>
                        <div class="chart-container !h-80"><canvas id="expenseDonutChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="transactions-view" class="view">
                 <div class="flex justify-between items-center mb-4">
                    <button id="clear-data-btn" class="text-sm text-red-600 hover:text-red-800">Clear All Data</button>
                    <select id="transaction-list-month-filter" class="bg-white border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-sm p-2"></select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 p-6 bg-stone-50 rounded-lg">
                        <h2 class="text-lg font-semibold mb-4">Add Expense</h2>
                        <form id="transaction-form" class="space-y-4">
                            <div>
                                <label for="transaction-date" class="block text-sm font-medium text-stone-600">Date</label>
                                <input type="date" id="transaction-date" required class="mt-1 block w-full bg-white border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 p-2">
                            </div>
                            <div>
                                <label for="description" class="block text-sm font-medium text-stone-600">Description</label>
                                <input type="text" id="description" required class="mt-1 block w-full bg-white border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 p-2">
                            </div>
                            <div>
                                <label for="amount" class="block text-sm font-medium text-stone-600">Amount</label>
                                <input type="number" id="amount" step="0.01" required class="mt-1 block w-full bg-white border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 p-2">
                            </div>
                            <div>
                                <label for="category-input" class="block text-sm font-medium text-stone-600">Category</label>
                                <input id="category-input" list="category-list" required class="mt-1 block w-full bg-white border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 p-2">
                                <datalist id="category-list"></datalist>
                            </div>
                            <div class="relative flex items-start">
                                <div class="flex h-6 items-center">
                                    <input id="is-recurring" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-600">
                                </div>
                                <div class="ml-3 text-sm leading-6">
                                    <label for="is-recurring" class="font-medium text-gray-900">Recurring</label>
                                </div>
                            </div>
                            <div id="recurring-options" class="hidden space-y-4 pt-2 border-t border-stone-200">
                                <div>
                                    <label for="recurring-frequency" class="block text-sm font-medium text-stone-600">Frequency</label>
                                    <select id="recurring-frequency" class="mt-1 block w-full bg-white border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 p-2">
                                        <option>Monthly</option>
                                        <option>Bi-Weekly</option>
                                    </select>
                                </div>
                                 <div>
                                    <label for="recurring-end-date" class="block text-sm font-medium text-stone-600">End Date</label>
                                    <input type="date" id="recurring-end-date" class="mt-1 block w-full bg-white border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 p-2">
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition">Add Expense</button>
                        </form>
                    </div>

                    <div class="md:col-span-2">
                        <h2 class="text-lg font-semibold mb-4">Transaction List</h2>
                        <div class="overflow-auto max-h-[28rem] bg-stone-50 rounded-lg p-2">
                            <table class="min-w-full divide-y divide-stone-200">
                                <thead class="bg-stone-100 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Description</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Category</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-stone-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-stone-500 uppercase tracking-wider"></th>
                                    </tr>
                                </thead>
                                <tbody id="transaction-table-body" class="bg-white divide-y divide-stone-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const state = {
        settings: { 
            existingSavings: 0, 
            savingsGoal: 10000,
            savingsEndDate: '2026-05-31'
        },
        transactions: [],
        categories: ['Rent', 'Groceries', 'Utilities', 'Transport', 'Entertainment', 'Shopping', 'Health', 'Other'],
        currentView: 'dashboard'
    };

    const monthMap = getMonths();
    let cashFlowChart, savingsTrendChart, expenseDonutChart;

    function saveData() {
        localStorage.setItem('budgetAppState', JSON.stringify(state));
    }

    function loadData() {
        const savedState = localStorage.getItem('budgetAppState');
        if (savedState) {
            const parsedState = JSON.parse(savedState);
            state.settings = parsedState.settings;
            state.transactions = parsedState.transactions;
            state.categories = parsedState.categories;
        } else {
            populateInitialIncome();
            saveData();
        }
    }

    function clearAllData() {
        if (confirm("Are you sure you want to clear all your budget data? This action cannot be undone.")) {
            localStorage.removeItem('budgetAppState');
            state.transactions = [];
            state.settings = { 
                existingSavings: 0, 
                savingsGoal: 10000,
                savingsEndDate: '2026-05-31'
            };
            state.categories = ['Rent', 'Groceries', 'Utilities', 'Transport', 'Entertainment', 'Shopping', 'Health', 'Other'];
            populateInitialIncome();
            saveData();
            updateUI();
            location.reload();
        }
    }
    
    function getMonths() {
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const monthsArray = [];
        let currentDate = new Date('2025-06-01');
        for (let i = 0; i < 12; i++) {
            monthsArray.push({
                name: `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`,
                year: currentDate.getFullYear(),
                month: currentDate.getMonth()
            });
            currentDate.setMonth(currentDate.getMonth() + 1);
        }
        return monthsArray;
    }

    function populateInitialIncome() {
        const paydays = [
            { date: "2025-06-05", amount: 2000 }, { date: "2025-06-19", amount: 2000 },
            { date: "2025-07-03", amount: 2000 }, { date: "2025-07-17", amount: 2000 }, { date: "2025-07-31", amount: 2000 },
            { date: "2025-08-14", amount: 2000 }, { date: "2025-08-28", amount: 2000 },
            { date: "2025-09-11", amount: 2000 }, { date: "2025-09-25", amount: 2000 },
            { date: "2025-10-09", amount: 2000 }, { date: "2025-10-23", amount: 2000 },
            { date: "2025-11-06", amount: 2000 }, { date: "2025-11-20", amount: 2000 },
            { date: "2025-12-04", amount: 2000 }, { date: "2025-12-18", amount: 2000 },
            { date: "2026-01-01", amount: 2000 }, { date: "2026-01-15", amount: 2000 }, { date: "2026-01-29", amount: 2000 },
            { date: "2026-02-12", amount: 2000 }, { date: "2026-02-26", amount: 2000 },
            { date: "2026-03-12", amount: 2000 }, { date: "2026-03-26", amount: 2000 },
            { date: "2026-04-09", amount: 2000 }, { date: "2026-04-23", amount: 2000 },
            { date: "2026-05-07", amount: 2000 }, { date: "2026-05-21", amount: 2000 }
        ];

        paydays.forEach(p => {
            state.transactions.push({ 
                id: crypto.randomUUID(),
                date: p.date, 
                description: 'Salary', 
                amount: p.amount, 
                category: 'Income', 
                type: 'income' 
            });
        });
    }

    function setupEventListeners() {
        document.getElementById('existing-savings').addEventListener('change', (e) => {
            state.settings.existingSavings = parseFloat(e.target.value) || 0;
            saveData();
            updateUI();
        });

        document.getElementById('savings-goal').addEventListener('change', (e) => {
            state.settings.savingsGoal = parseFloat(e.target.value) || 0;
            saveData();
            updateUI();
        });

        document.getElementById('savings-end-date').addEventListener('change', (e) => {
            state.settings.savingsEndDate = e.target.value;
            saveData();
            updateUI();
        });

        document.getElementById('nav-dashboard').addEventListener('click', () => switchView('dashboard'));
        document.getElementById('nav-transactions').addEventListener('click', () => switchView('transactions'));
        document.getElementById('transaction-form').addEventListener('submit', addTransaction);
        document.getElementById('transaction-list-month-filter').addEventListener('change', () => renderTransactions());
        document.getElementById('transaction-table-body').addEventListener('click', (e) => {
            if (e.target.closest('.delete-btn')) {
                deleteTransaction(e.target.closest('.delete-btn').dataset.id);
            }
        });
        document.getElementById('cash-flow-month-filter').addEventListener('change', () => updateCashFlowChart());
        document.getElementById('expense-chart-month-filter').addEventListener('change', () => updateExpenseDonutChart());
        document.getElementById('is-recurring').addEventListener('change', (e) => {
            document.getElementById('recurring-options').classList.toggle('hidden', !e.target.checked);
        });
        document.getElementById('clear-data-btn').addEventListener('click', clearAllData);
    }
    
    function switchView(viewName) {
        state.currentView = viewName;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(`${viewName}-view`).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('text-teal-600', 'border-teal-500');
            btn.classList.add('text-stone-500', 'border-transparent');
        });
        document.getElementById(`nav-${viewName}`).classList.add('text-teal-600', 'border-teal-500');
    }
    
    function populateCategoryDatalist() {
        const datalist = document.getElementById('category-list');
        datalist.innerHTML = '';
        state.categories.forEach(cat => {
            datalist.innerHTML += `<option value="${cat}">`;
        });
    }

    function populateSelectors() {
        const selectors = [
            document.getElementById('cash-flow-month-filter'),
            document.getElementById('expense-chart-month-filter'),
            document.getElementById('transaction-list-month-filter')
        ];
        
        selectors.forEach(selector => {
            if(selector.id !== 'expense-chart-month-filter') selector.innerHTML = '';
            monthMap.forEach(month => {
                selector.innerHTML += `<option value="${month.name}">${month.name}</option>`;
            });
        });
    }

    function addTransaction(e) {
        e.preventDefault();
        const dateStr = document.getElementById('transaction-date').value;
        const description = document.getElementById('description').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const category = document.getElementById('category-input').value;
        const isRecurring = document.getElementById('is-recurring').checked;
        
        if (!description || !amount || !dateStr || !category) return;
        
        if (isRecurring) {
            const frequency = document.getElementById('recurring-frequency').value;
            const endDateStr = document.getElementById('recurring-end-date').value;
            if (!endDateStr) return;

            const recurringId = crypto.randomUUID();
            let currentDate = new Date(dateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T00:00:00');

            while (currentDate <= endDate) {
                const transaction = {
                    id: crypto.randomUUID(),
                    recurringId: recurringId,
                    date: currentDate.toISOString().split('T')[0],
                    description, amount, category, type: 'expense'
                };
                state.transactions.push(transaction);

                if (frequency === 'Monthly') {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                } else if (frequency === 'Bi-Weekly') {
                    currentDate.setDate(currentDate.getDate() + 14);
                }
            }
        } else {
            const newTransaction = { id: crypto.randomUUID(), date: dateStr, description, amount, category, type: 'expense' };
            state.transactions.push(newTransaction);
        }

        if (!state.categories.includes(category)) {
            state.categories.push(category);
            populateCategoryDatalist();
        }
        
        saveData();
        updateUI();
        e.target.reset();
        document.getElementById('transaction-date').value = dateStr;
        document.getElementById('recurring-options').classList.add('hidden');
    }

    function deleteTransaction(id) {
        state.transactions = state.transactions.filter(t => t.id !== id);
        saveData();
        updateUI();
    }
    
    function renderTransactions() {
        const tableBody = document.getElementById('transaction-table-body');
        tableBody.innerHTML = '';
        const selectedMonthName = document.getElementById('transaction-list-month-filter').value;
        const selectedMonth = monthMap.find(m => m.name === selectedMonthName);
        if (!selectedMonth) return;

        const monthlyTransactions = state.transactions.filter(t => {
            const tDate = new Date(t.date + 'T00:00:00');
            return tDate.getFullYear() === selectedMonth.year && tDate.getMonth() === selectedMonth.month;
        }).sort((a,b) => new Date(a.date) - new Date(b.date));
        
        const expenseTransactions = monthlyTransactions.filter(t => t.type === 'expense');
        if(expenseTransactions.length === 0){
             tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-stone-500">No expenses added for this month yet.</td></tr>`;
             return;
        }
        
        expenseTransactions.forEach(t => {
            const row = `
                <tr class="hover:bg-stone-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${t.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-stone-900">${t.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${t.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-red-600">-$${t.amount.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="delete-btn text-stone-400 hover:text-red-600" data-id="${t.id}">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    }

    function updateSummary() {
        const endDate = new Date(state.settings.savingsEndDate + 'T23:59:59');

        const filteredTransactions = state.transactions.filter(t => new Date(t.date) <= endDate);

        const totalIncome = filteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
        const totalExpenses = filteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
        const projectedSavings = state.settings.existingSavings + totalIncome - totalExpenses;
        const progress = state.settings.savingsGoal > 0 ? (projectedSavings / state.settings.savingsGoal) * 100 : 0;

        document.getElementById('projected-savings').textContent = `$${projectedSavings.toFixed(2)}`;
        document.getElementById('total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
        document.getElementById('existing-savings').value = state.settings.existingSavings;
        document.getElementById('savings-goal').value = state.settings.savingsGoal;
        document.getElementById('savings-end-date').value = state.settings.savingsEndDate;
        
        const progressBar = document.getElementById('progress-bar');
        progressBar.style.width = `${Math.min(100, Math.max(0, progress))}%`;
        document.getElementById('progress-text').textContent = `${Math.round(progress)}%`;
    }
    
    function updateCharts() {
        updateCashFlowChart();
        updateSavingsTrendChart();
        updateExpenseDonutChart();
    }
    
    function createChart(ctx, config) {
        if (!ctx) return null;
        return new Chart(ctx, config);
    }
    
    function updateCashFlowChart() {
        const ctx = document.getElementById('cashFlowChart')?.getContext('2d');
        if (!ctx) return;
        const selectedMonthName = document.getElementById('cash-flow-month-filter').value;
        const selectedMonthInfo = monthMap.find(m => m.name === selectedMonthName);
        if (!selectedMonthInfo) return;

        const startDate = new Date(selectedMonthInfo.year, selectedMonthInfo.month, 1);
        const endDate = new Date(selectedMonthInfo.year, selectedMonthInfo.month + 1, 0);

        let balance = state.settings.existingSavings + state.transactions
            .filter(t => new Date(t.date) < startDate)
            .reduce((acc, t) => acc + (t.type === 'income' ? t.amount : -t.amount), 0);

        const dailyData = new Map();
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const dateString = d.toISOString().split('T')[0];
            const todaysTransactions = state.transactions.filter(t => t.date === dateString);
            if (todaysTransactions.length > 0) {
                 balance += todaysTransactions.reduce((acc, t) => acc + (t.type === 'income' ? t.amount : -t.amount), 0);
            }
            dailyData.set(dateString, balance);
        }

        const data = {
            labels: Array.from(dailyData.keys()),
            datasets: [{
                label: 'Running Balance',
                data: Array.from(dailyData.values()),
                fill: true,
                backgroundColor: 'rgba(56, 189, 248, 0.2)',
                borderColor: 'rgba(14, 165, 233, 1)',
                tension: 0.1,
                pointRadius: 2,
            }]
        };

        if (cashFlowChart) cashFlowChart.destroy();
        cashFlowChart = createChart(ctx, {
            type: 'line', data, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' } } } }
        });
    }

    function updateSavingsTrendChart() {
        const ctx = document.getElementById('savingsTrendChart')?.getContext('2d');
        if (!ctx) return;

        const savingsData = monthMap.map(monthInfo => {
            const lastDayOfMonth = new Date(monthInfo.year, monthInfo.month + 1, 0);
            const monthEndBalance = state.transactions
                .filter(t => new Date(t.date) <= lastDayOfMonth)
                .reduce((acc, t) => acc + (t.type === 'income' ? t.amount : -t.amount), state.settings.existingSavings);
            return { x: lastDayOfMonth.getTime(), y: monthEndBalance };
        });

        const data = {
            datasets: [{
                label: 'Cumulative Savings',
                data: savingsData,
                fill: true,
                backgroundColor: 'rgba(34, 197, 94, 0.2)',
                borderColor: 'rgba(34, 197, 94, 1)',
                tension: 0.1
            }]
        };

        if (savingsTrendChart) savingsTrendChart.destroy();
        savingsTrendChart = createChart(ctx, {
            type: 'line', data, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'month' } } } }
        });
    }
    
    function updateExpenseDonutChart() {
        const ctx = document.getElementById('expenseDonutChart')?.getContext('2d');
        if (!ctx) return;

        const monthFilter = document.getElementById('expense-chart-month-filter').value;
        
        const filteredTransactions = (monthFilter === 'all')
            ? state.transactions.filter(t => t.type === 'expense')
            : state.transactions.filter(t => {
                const monthInfo = monthMap.find(m => m.name === monthFilter);
                if (!monthInfo) return false;
                const tDate = new Date(t.date + 'T00:00:00');
                return t.type === 'expense' && tDate.getFullYear() === monthInfo.year && tDate.getMonth() === monthInfo.month;
            });

        const categoryTotals = state.categories.map(cat => {
            return filteredTransactions.filter(t => t.category === cat).reduce((sum, t) => sum + t.amount, 0);
        });

        const presentCategories = state.categories.filter((cat, index) => categoryTotals[index] > 0);
        const presentTotals = categoryTotals.filter(total => total > 0);

        const data = {
            labels: presentCategories,
            datasets: [{
                label: 'Expenses',
                data: presentTotals,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)',
                    'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)',
                    'rgba(201, 203, 207, 0.7)', 'rgba(148, 159, 177, 0.7)', 'rgba(210, 100, 200, 0.7)', 'rgba(100,210,120,0.7)'
                ].slice(0, presentCategories.length),
                borderColor: '#fff',
                borderWidth: 2
            }]
        };

        if (expenseDonutChart) expenseDonutChart.destroy();
        expenseDonutChart = createChart(ctx, {
            type: 'doughnut', data, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });
    }

    function updateUI() {
        updateSummary();
        populateCategoryDatalist();
        populateSelectors();
        if (state.currentView === 'transactions') {
            renderTransactions();
        }
        updateCharts();
    }
    
    function init() {
        loadData();
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('transaction-date').value = today;
        document.getElementById('savings-end-date').value = state.settings.savingsEndDate;
        document.getElementById('recurring-end-date').value = "2026-05-31";
        setupEventListeners();
        updateUI();
    }

    init();
});
</script>
</body>
</html>